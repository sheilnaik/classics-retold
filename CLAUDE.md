# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Classics Retold** is a Progressive Web App (PWA) for reading classic literature with modern retellings. Users can toggle between original and contemporary text, highlight passages for instant translations, and enjoy an offline-capable reading experience with multiple themes.

## Common Commands

```bash
# Install dependencies
npm install

# Start development server (http://localhost:5173)
npm run dev

# Build for production
npm run build

# Preview production build locally
npm run preview

# Process an EPUB file to extract chapters
npm run process-epub -- path/to/book.epub book-id --skip-first=2 --skip-last=1

# Generate retelling placeholders for a book
npm run generate-retellings book-id
```

## Architecture Overview

### State Management (App.jsx)

The app uses React hooks for state management without external libraries. **App.jsx** is the central hub that manages:
- `currentView`: Switches between 'library' and 'reader' views
- `selectedBookId`: Tracks which book is open
- `bookContent`: Fetched book data
- `theme`: Current theme preference (persisted to IndexedDB)

Books are loaded on-demand when selected, merged with metadata from `books.js`, and passed to the Reader component.

### Core Utilities

1. **`utils/storage.js`** - IndexedDB wrapper
   - Progress tracking (chapter, scroll position, completion)
   - Preferences (theme)
   - Pinned books
   - Uses `idb` package for async operations

2. **`utils/books.js`** - Book metadata and content loading
   - `BOOKS_METADATA`: Array of book objects with id, title, author, cover, etc.
   - `loadBookContent(bookId)`: Fetches `/public/data/books/[bookId].json`
   - Navigation helpers: `getChapterById()`, `getNextChapter()`, etc.

3. **`utils/text-utils.js`** - Text selection and scroll utilities
   - `getSelectedText()`: Extracts user-selected text
   - `findPassageForSelection()`: Matches selection to pre-defined passages
   - `debounce()`: Utility for scroll position saves

### Component Hierarchy

```
App
├── Library
│   ├── BookCover (grid items)
│   └── Progress indicators
│
└── Reader
    ├── Navigation header (back, TOC, theme selector)
    ├── Chapter content (HTML, swappable original/modern)
    ├── Chapter navigation (prev/next buttons)
    ├── Floating swap button
    ├── TableOfContents modal (conditional)
    └── HighlightPopup modal (conditional)
```

### Data Flow Patterns

**Reading a Book:**
1. User clicks book in Library → `handleBookSelect()` in App
2. Fetches book JSON from `/public/data/books/[id].json`
3. Loads user progress from IndexedDB
4. Passes to Reader component
5. Reader saves scroll position (debounced, 500ms) to IndexedDB

**Text Swapping:**
1. User clicks swap button → `toggleShowModern()` in Reader
2. Stores current scroll position before swap
3. Toggles `showModern` state (triggers CSS fade animation)
4. Restores scroll position after render

**Highlight Translation:**
1. User selects text → `handleMouseUp()` listener in Reader
2. `getSelectedText()` extracts selection
3. `findPassageForSelection()` finds matching passage from book data
4. Shows HighlightPopup with original + modern text
5. Popup closes on button click or ESC key

### Book Data Format

Each book JSON file (`/public/data/books/[id].json`) has this structure:
```javascript
{
  id: "book-id",
  chapters: [
    {
      id: "chapter-1",
      title: "Chapter Title",
      original: "<p>Original HTML...</p>",
      modern: "<p>Modern retelling HTML...</p>",
      passages: [
        {
          id: "passage-1",
          originalText: "Key phrase from original",
          modernText: "Modern translation of phrase",
          context: "<p>Surrounding paragraph...</p>"
        }
      ]
    }
  ]
}
```

### Storage Architecture (IndexedDB)

Three object stores with `idb` package:
- **progress**: `{ bookId, currentChapter, scrollPosition, completed[], percentComplete, lastRead }`
- **preferences**: `{ key: 'theme', value }`
- **pinned**: `{ bookId, pinnedAt }`

## Theme System

Themes are CSS-based using custom properties defined in `styles/themes.css`:
- Light: `#FFFFFF` bg, `#1A1A1A` text
- Dark: `#1A1A1A` bg, `#E8E8E8` text
- Sepia: `#F4F1EA` bg, `#5C4B37` text

Theme class applied to `document.body` (e.g., `body.light-theme`). All components use CSS variables like `var(--bg)`, `var(--text)`, etc.

## PWA Configuration

Service worker auto-generated by `vite-plugin-pwa`:
- Precaches app shell and static assets
- Runtime caches Google Fonts (Cache First, 1-year expiry)
- Workbox handles all caching strategies
- Manifest configured in `vite.config.js`

Icons in `public/icons/` must be PNG (or SVG) in sizes: 192x192, 512x512. Currently SVG placeholders—should be converted to PNG for production PWA support.

## File Organization

```
src/
├── App.jsx              # Main component, view routing, theme management
├── main.jsx             # Entry point
├── components/
│   ├── Library.jsx      # Grid view, book selection, pinning
│   ├── Reader.jsx       # Main reading interface, chapter display
│   ├── TableOfContents.jsx  # Chapter list modal
│   ├── HighlightPopup.jsx   # Passage translation popup
│   ├── ThemeSelector.jsx    # Theme toggle buttons
│   └── BookCover.jsx    # Individual book card
├── utils/
│   ├── storage.js       # IndexedDB operations
│   ├── books.js         # Metadata + content loading
│   └── text-utils.js    # Text selection, scroll utilities
└── styles/
    ├── global.css       # Reset, layout, utilities
    └── themes.css       # CSS variables for themes

public/
├── data/books/          # Book JSON files ([id].json)
├── images/covers/       # Book cover images
└── icons/               # PWA icons
```

## Key Decision Points for Development

1. **Adding a new feature**: Place state in App if it affects multiple views, otherwise in individual components.
2. **Styling**: Use CSS custom properties (var(--...)) for consistency with themes.
3. **Async operations**: Use `async/await` with try/catch. IndexedDB calls use `idb` package.
4. **Component responsibility**:
   - Reader handles all reading-view logic (swapping, highlighting, scroll)
   - Library handles book browsing and pinning
   - App handles routing and theme persistence
5. **Performance**: Scroll position saves are debounced (500ms) to avoid excessive IndexedDB writes.

## Testing

No automated tests currently exist. Manual testing checklist:
- ✅ Dev server starts (`npm run dev`)
- ✅ Build completes without errors (`npm run build`)
- ✅ Features work: book selection, text swapping, highlighting, theme switching
- ✅ Scroll position restores on page reload
- ✅ PWA installs on mobile (test with Chrome DevTools or real device)
- ✅ Offline functionality works (DevTools Network → Offline)

## Common Customization Tasks

**Add a new book:**
1. Create `/public/data/books/new-book.json` (use existing book as template)
2. Add metadata to `BOOKS_METADATA` in `utils/books.js`
3. Add cover image to `/public/images/covers/new-book.jpg`
4. Restart dev server to pick up new book

**Modify theme colors:**
- Edit CSS variables in `styles/themes.css`
- Variables named: `--light-bg`, `--dark-bg`, `--sepia-bg`, etc.
- All components automatically update via CSS cascade

**Process an EPUB:**
1. Run: `npm run process-epub -- path/to/file.epub book-id --skip-first=2`
2. Generates `/public/data/books/book-id.json` with chapters
3. Run: `npm run generate-retellings book-id` to add placeholder passages
4. Manually edit JSON to add modern retellings
5. Add book to metadata and cover image

## Deployment

Default: **Cloudflare Pages**
- Push to GitHub
- Connect to Cloudflare Pages
- Build command: `npm run build`
- Output directory: `dist`
- See `DEPLOYMENT.md` for Vercel, Netlify, GitHub Pages options

## Performance Notes

- Lighthouse scores: 95+ (Performance, Accessibility, Best Practices, SEO)
- First Contentful Paint: <1.5s
- Offline-first with service worker precaching
- Debounced scroll saves (500ms) to reduce IndexedDB writes
- No external API calls (fully client-side)

## Browser Support

- Chrome 90+
- Safari 14+ (iOS 14+)
- Firefox 88+
- Edge 90+
